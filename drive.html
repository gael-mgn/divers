<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Enregistrer audio et envoyer vers Drive</title>
</head>
<body>
  <h1>Enregistrement audio vers Google Drive</h1>

  <button id="startBtn">🎤 Commencer l'enregistrement</button>
  <button id="stopBtn" disabled>⏹️ Arrêter l'enregistrement</button>

  <p id="status"></p>
  <audio id="audioPlayback" controls></audio>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzLmQjOdv0KX0BYFa7Lvo6vLyKeDh-t0OEUuozfaMquAF_DUEn1LuMPqOqwK1nDG7q9/exec"; // URL du script déployé
    const FOLDER_ID = "133Iuv3NsDuwT-sFHP3zEH3zT60r2vXHx";        // ID du dossier Google Drive

    let mediaRecorder;
    let audioChunks = [];

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const status = document.getElementById("status");
    const audioPlayback = document.getElementById("audioPlayback");

    startBtn.onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        audioPlayback.src = URL.createObjectURL(audioBlob);

        // Lire le blob en base64
        const reader = new FileReader();
        reader.onloadend = () => {
          const base64Data = reader.result.split(',')[1];

          // Envoi au script Google Apps Script
          fetch(SCRIPT_URL, {
            method: "POST",
            body: new URLSearchParams({
              filename: `enregistrement_${Date.now()}.webm`,
              mimetype: 'audio/webm',
              data: base64Data,
              folderId: FOLDER_ID
            })
          })
          .then(res => res.json())
          .then(data => {
            if (data.status === "success") {
              status.innerHTML = `✅ Audio uploadé : <a href="${data.fileUrl}" target="_blank">Ouvrir</a>`;
            } else {
              status.textContent = "Erreur : " + data.message;
            }
          })
          .catch(err => status.textContent = "Erreur réseau : " + err);
        };
        reader.readAsDataURL(audioBlob);
      };

      mediaRecorder.start();
      startBtn.disabled = true;
      stopBtn.disabled = false;
      status.textContent = "Enregistrement en cours...";
    };

    stopBtn.onclick = () => {
      mediaRecorder.stop();
      startBtn.disabled = false;
      stopBtn.disabled = true;
      status.textContent = "Traitement et envoi de l'audio...";
    };
  </script>
</body>
</html>
