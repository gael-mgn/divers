<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Enregistrement audio vers Google Drive</title>
<style>
  body { font-family: sans-serif; margin: 2rem; }
  button { margin: 0.5rem; padding: 0.5rem 1rem; }
  #progressContainer { width: 100%; background: #eee; height: 10px; border-radius: 5px; margin-top: 10px; display: none; }
  #progressBar { height: 100%; background: #4caf50; width: 0%; border-radius: 5px; }
</style>
</head>
<body>
<h1>üéôÔ∏è Enregistrement audio ‚Üí Google Drive</h1>
<button id="startBtn">D√©marrer</button>
<button id="stopBtn" disabled>Arr√™ter</button>
<div id="progressContainer"><div id="progressBar"></div></div>
<p id="status"></p>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyUCevaR3XeLsN7kO1eUzXf9RfGVGagPmXc7XjNfgFuvlUGFQs1iSjqDYJ0m1YZB3jq/exec"; // URL /exec du d√©ploiement Google Apps Script
let mediaRecorder;
let audioChunks = [];

// G√©n√©ration d'un nom de fichier horodat√©
function getFileName(extension = "webm") {
    const now = new Date();
    const pad = n => String(n).padStart(2, "0");
    return `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}-${pad(now.getSeconds())}.${extension}`;
}

// Start recording
document.getElementById("startBtn").onclick = async () => {
    let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) audioChunks.push(e.data);
    };

    mediaRecorder.onstop = async () => {
        let mimeType = mediaRecorder.mimeType || "audio/webm";
        let extension = mimeType.split("/")[1] || "webm";
        let blob = new Blob(audioChunks, { type: mimeType });
        let filename = getFileName(extension);

        let formData = new FormData();
        formData.append("file", blob);
        formData.append("filename", filename);

        document.getElementById("status").textContent = "Envoi en cours...";
        document.getElementById("progressContainer").style.display = "block";

        let xhr = new XMLHttpRequest();
        xhr.open("POST", SCRIPT_URL, true);

        xhr.upload.onprogress = e => {
            if (e.lengthComputable) {
                let percent = (e.loaded / e.total) * 100;
                document.getElementById("progressBar").style.width = percent + "%";
            }
        };

        xhr.onload = () => {
            document.getElementById("progressContainer").style.display = "none";
            if (xhr.status === 200) {
                try {
                    let result = JSON.parse(xhr.responseText);
                    if (result.success) {
                        document.getElementById("status").innerHTML = `‚úÖ Fichier enregistr√© : <a href="${result.fileUrl}" target="_blank">${filename}</a>`;
                    } else {
                        document.getElementById("status").textContent = "Erreur : " + result.message;
                    }
                } catch {
                    document.getElementById("status").textContent = "R√©ponse inattendue : " + xhr.responseText;
                }
            } else {
                document.getElementById("status").textContent = "Erreur HTTP : " + xhr.status;
            }
        };

        xhr.send(formData);
    };

    mediaRecorder.start();
    document.getElementById("startBtn").disabled = true;
    document.getElementById("stopBtn").disabled = false;
    document.getElementById("status").textContent = "Enregistrement en cours...";
};

// Stop recording
document.getElementById("stopBtn").onclick = () => {
    mediaRecorder.stop();
    document.getElementById("startBtn").disabled = false;
    document.getElementById("stopBtn").disabled = true;
};
</script>
</body>
</html>
